<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Opulent Voice Radio Interface</title>

	<!-- Font preloading -->
	<link rel="preload" href="/static/fonts/AtkinsonHyperlegibleNext-Regular.woff2" as="font" type="font/woff2" crossorigin>
	<link rel="preload" href="/static/fonts/AtkinsonHyperlegibleNext-Bold.woff2" as="font" type="font/woff2" crossorigin>
    
	<!-- CSS Files -->
	<link rel="stylesheet" href="/static/css/typography.css">
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/audio.css">
	<link rel="stylesheet" href="/static/css/responsive.css">
	
	<!-- Accessibility and SEO -->
	<meta name="description" content="Amateur Radio Digital Voice and Chat Interface">
	<meta name="theme-color" content="#1a1a2e">
	
	<!-- Skip link for keyboard users -->
	<a href="#main-content" class="skip-link">Skip to main content</a>
	
	<style>
		.skip-link {
			position: absolute;
			top: -40px;
			left: 6px;
			background: #000;
			color: #fff;
			padding: 8px;
			text-decoration: none;
			border-radius: 0 0 4px 4px;
			z-index: 1000;
		}
		.skip-link:focus {
			top: 0;
		}
		
		.required-indicator {
			font-weight: normal;
			color: #666;
			font-size: 0.9em;
		}
		
		/* Ensure form validation styling doesn't rely on color alone */
		.form-group input:invalid {
			border-color: #d32f2f;
			border-width: 2px;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23d32f2f' viewBox='0 0 16 16'%3E%3Cpath d='M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z'/%3E%3Cpath d='M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 8px center;
			background-size: 16px;
			padding-right: 32px;
		}
		
		.form-group input:valid {
			border-color: #2e7d32;
			border-width: 2px;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%232e7d32' viewBox='0 0 16 16'%3E%3Cpath d='M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z'/%3E%3Cpath d='M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 8px center;
			background-size: 16px;
			padding-right: 32px;
		}
	</style>
	
</head>
<body>
	<!-- Screen reader announcements -->
	<div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only"></div>
	<div id="sr-status" aria-live="assertive" aria-atomic="true" class="sr-only"></div>
	
	<header role="banner" class="main-header">
		<div class="header-content">
			<h1 class="app-title">
				<span class="app-icon" aria-hidden="true">üìª</span>
				Opulent Voice Radio
			</h1>
			
			<div class="connection-status" id="connection-status" role="status" aria-live="polite">
				<span class="status-indicator connecting" aria-label="Connection status"></span>
				<span class="status-text">Connecting...</span>
			</div>
			
			<div class="header-controls">
				<nav class="tab-navigation" role="tablist">
					<button class="tab-button active" 
							role="tab" 
							aria-selected="true" 
							aria-controls="chat-panel"
							id="chat-tab"
							onclick="switchTab('chat')">
						üí¨ Chat
					</button>
					<button class="tab-button" 
							role="tab" 
							aria-selected="false" 
							aria-controls="config-panel"
							id="config-tab"
							onclick="switchTab('config')">
						‚öôÔ∏è Configuration
					</button>
				</nav>
			</div>
		</div>
	</header>

	<main id="main-content" role="main" class="main-container">
		
		<!-- Chat Panel (Default View) -->
		<div id="chat-panel" class="panel" role="tabpanel" aria-labelledby="chat-tab">
			<h2 class="panel-title">
				<span class="panel-icon">üí¨</span>
				Communications
			</h2>
			
			<div class="chat-container">
				<div class="chat-header">
					<div class="station-info">
						<span>Station: </span>
						<strong id="current-station">CONNECTING...</strong>
					</div>
					
					<button id="ptt-button" 
							class="ptt-button" 
							aria-pressed="false"
							aria-describedby="ptt-help"
							disabled>
						<span aria-hidden="true">üé§</span>
						<span class="ptt-text">Push to Talk</span>
					</button>
					<div id="ptt-help" class="sr-only">Press and hold to transmit voice message, release to stop</div>
				</div>
				
				<div id="message-history" 
					 class="message-history" 
					 role="log" 
					 aria-live="polite" 
					 aria-label="Message history"
					 tabindex="0">
					<div class="message system">
						<div>Welcome to Opulent Voice Radio Interface</div>
						<div class="message-meta">
							<span>System</span>
							<span id="welcome-time"></span>
						</div>
					</div>
				</div>
				
				<!-- Connection retry panel (initially hidden) -->
				<div id="connection-retry" class="connection-retry" style="display: none;">
					<div>Connection lost to radio system</div>
					<button class="retry-button" onclick="attemptReconnect()">Retry Connection</button>
				</div>
				
				<form id="message-form" class="message-input-form" novalidate>
					<div class="input-container">
						<label for="message-input">Message to send</label>
						<textarea id="message-input"
							class="message-input"
							placeholder="Type your message..."
							rows="1"
							aria-describedby="message-help"
							disabled></textarea>
						<div id="message-help" class="sr-only">Enter your radio message and press Send or Enter to transmit</div>
					</div>
					<button type="submit"
						class="send-button"
						disabled>
						Send Message
					</button>
				</form>				
			</div>
		</div>

		<!-- Configuration Panel -->
		<div id="config-panel" class="config-tabs" role="tabpanel" aria-labelledby="config-tab">
			<h2 class="panel-title">
				<span class="panel-icon">‚öôÔ∏è</span>
				Configuration Management
			</h2>
			
			<!-- Configuration Management Section -->
			<div class="config-section config-management-consolidated">
				<h3 class="section-header">
					<span aria-hidden="true">üìã</span>
					Configuration Management
				</h3>
				
				<!-- Current Configuration Status -->
				<div class="config-status-display">
					<div class="current-file-status">
						<div class="status-item">
							<label class="status-label">üìÑ Active Configuration File:</label>
							<span id="current-config-file" class="status-value">No file loaded</span>
						</div>
					</div>
				</div>
				
				<!-- File Operations Section -->
				<div class="config-file-operations">
					<h4 class="operation-group-title">üìÇ File Operations</h4>
					
					<!-- Load Configuration -->
					<div class="operation-group">
						<div class="operation-controls">
							<div class="input-group">
								<label for="load-config-filename" class="operation-label">Load Configuration File</label>
								<input type="text" 
									   id="load-config-filename" 
									   placeholder="Leave empty for auto-discovery"
									   class="config-filename-input">
								<button class="btn btn-primary operation-btn" onclick="loadConfigFile()">
									<span aria-hidden="true">üìÇ</span>
									Load
								</button>
							</div>
							<div class="operation-help">
								Auto-discovery searches: opulent_voice.yaml ‚Üí config/opulent_voice.yaml ‚Üí ~/.config/opulent_voice/config.yaml
							</div>
						</div>
					</div>
					
					<!-- Save Configuration -->
					<div class="operation-group">
						<div class="operation-controls">
							<div class="input-group">
								<label for="save-config-filename" class="operation-label">Save Configuration File</label>
								<input type="text" 
									   id="save-config-filename" 
									   placeholder="Leave empty to save to original file"
									   class="config-filename-input">
								<button class="btn btn-success operation-btn" onclick="saveConfigFile()">
									<span aria-hidden="true">üíæ</span>
									Save
								</button>
							</div>
							<div class="operation-help">
								Saves current form settings to file. Empty filename saves to original loaded file.
							</div>
						</div>
					</div>
					
					<!-- Create Template Configuration -->
					<div class="operation-group">
						<div class="operation-controls">
							<div class="input-group">
								<label for="create-config-filename" class="operation-label">Create Template Configuration File</label>
								<input type="text" 
									   id="create-config-filename" 
									   placeholder="opulent-voice.yaml"
									   class="config-filename-input">
								<button class="btn operation-btn" onclick="createConfigFileEnhanced()">
									<span aria-hidden="true">üìÑ</span>
									Create Template
								</button>
							</div>
							<div class="operation-help">
								Creates a sample configuration with comments and examples
							</div>
						</div>
					</div>
				</div>
				
				<!-- Configuration Actions Section -->
				<div class="config-actions-section">
					<h4 class="operation-group-title">‚öôÔ∏è Configuration Actions</h4>
					
					<div class="action-buttons-grid">
						<!-- Apply to System -->
						<div class="action-group">
							<button class="btn btn-primary action-btn" onclick="applyConfig()">
								<span aria-hidden="true">‚úÖ</span>
								<div class="btn-content">
									<div class="btn-title">Apply Changes</div>
									<div class="btn-subtitle">Update running system</div>
								</div>
							</button>
							<div class="action-help">
								Applies current form settings to the running radio system (does not save to file)
							</div>
						</div>
						
						<!-- Test System -->
						<div class="action-group">
							<button class="btn action-btn" onclick="testConnection()">
								<span aria-hidden="true">üß™</span>
								<div class="btn-content">
									<div class="btn-title">Test System</div>
									<div class="btn-subtitle">Validate configuration</div>
								</div>
							</button>
							<div class="action-help">
								Tests network, audio, GPIO, and validates current form settings
							</div>
						</div>
						
						<!-- Reset Form -->
						<div class="action-group">
							<button class="btn action-btn" onclick="resetToDefaults()">
								<span aria-hidden="true">üîÑ</span>
								<div class="btn-content">
									<div class="btn-title">Reset Form</div>
									<div class="btn-subtitle">Restore defaults</div>
								</div>
							</button>
							<div class="action-help">
								Resets all form fields to default values (does not affect saved files)
							</div>
						</div>
					</div>
				</div>
				
				<!-- Status and Feedback Section -->
				<div class="config-feedback-section">
					<h4 class="operation-group-title">üìä Status</h4>
					<div class="config-status-container">
						<div id="config-status" class="config-status-message">
							Ready to manage configuration files and settings
						</div>
						<div id="config-operation-progress" class="operation-progress" style="display: none;">
							<div class="progress-spinner"></div>
							<span class="progress-text">Processing...</span>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Configuration Form Sections -->
			<div class="config-grid">
				<!-- Station Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üì°</span>
						Station Settings
					</h3>
					
					<div class="form-group">
						<label for="callsign">Callsign * <span class="required-indicator">(Required)</span></label>
						<input type="text" 
							   id="callsign" 
							   placeholder="N0CALL" 
							   maxlength="10" 
							   required
							   aria-required="true"
							   aria-describedby="callsign-help">
						<div id="callsign-help" class="help-text">
							The name for your station, such as an amateur radio callsign (A-Z, 0-9, -, /, .)
						</div>
					</div>
				</div>

				<!-- Network Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üåê</span>
						Network Settings
					</h3>
					
					<div class="form-group">
						<label for="target-ip">Target IP Address</label>
						<input type="text" 
							   id="target-ip" 
							   placeholder="192.168.2.152"
							   aria-describedby="target-ip-help">
						<div id="target-ip-help" class="help-text">
							IP address of target system
						</div>
					</div>
					
					<div class="form-group">
						<label for="target-port">Target Port</label>
						<input type="number" 
							   id="target-port" 
							   placeholder="57372" 
							   min="1" 
							   max="65535"
							   aria-describedby="target-port-help">
						<div id="target-port-help" class="help-text">
							UDP port for radio communication
						</div>
					</div>
					
					<div class="form-group">
						<label for="listen-port">Listen Port</label>
						<input type="number" 
							   id="listen-port" 
							   placeholder="57372" 
							   min="1" 
							   max="65535"
							   aria-describedby="listen-port-help">
						<div id="listen-port-help" class="help-text">
							Local port for receiving messages
						</div>
					</div>
				</div>

				<!-- Transcription Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üó®Ô∏è</span>
						Transcription Settings
					</h3>
					
					<!-- Essential Controls Only -->
					<div class="checkbox-group">
						<input type="checkbox" id="transcription-enabled">
						<label for="transcription-enabled">Enable Audio Transcription</label>
						<div class="help-text">
							Convert received voice messages to text automatically
						</div>
					</div>
					
					<div class="form-group">
						<label for="transcription-confidence">Confidence Threshold Slider</label>
						<input type="range" 
							   id="transcription-confidence" 
							   min="0.3" 
							   max="0.95" 
							   step="0.05" 
							   value="0.7"
							   aria-describedby="confidence-help">
						<div class="range-value">
							<span id="confidence-value">70%</span>
						</div>
						<div id="confidence-help" class="help-text">
							The confidence level below which we will print the transcription in italics.
						</div>
					</div>
					
					<!-- Advanced Settings (Read-only display) -->
					<div class="advanced-settings">
						<div class="help-text">
							 <strong>For advanced users:</strong> Edit the YAML config file for additional configuration options (processing method, language, model size). 
						</div>
					</div>
				</div>

				<!-- Compact Text-to-Speech Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üîä</span>
						Text-to-Speech Settings
					</h3>

					<!-- Single row with main enable checkbox -->
					<div class="checkbox-group" style="margin-bottom: 0.75rem;">
						<input type="checkbox" id="tts-enabled">
						<label for="tts-enabled">Enable Text-to-Speech</label>
					</div>

					<!-- Ultra-compact 2x2 grid for all TTS options -->
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
						<div class="checkbox-group" style="margin: 0;">
							<input type="checkbox" id="tts-incoming">
							<label for="tts-incoming">üì• Read incoming</label>
						</div>
						<div class="checkbox-group" style="margin: 0;">
							<input type="checkbox" id="tts-outgoing">
							<label for="tts-outgoing">üì§ Read outgoing</label>
						</div>
						<div class="checkbox-group" style="margin: 0;">
							<input type="checkbox" id="include-station-id">
							<label for="include-station-id">Include Station ID</label>
						</div>
						<div class="checkbox-group" style="margin: 0;">
							<input type="checkbox" id="include-confirmation">
							<label for="include-confirmation">Say Message Sent: as an outgoing message prefix</label>
						</div>
					</div>

					<!-- Inline speech rate control -->
					<div style="display: flex; align-items: center; gap: 1rem; font-size: 0.9rem;">
						<label for="speech-rate" style="margin: 0; white-space: nowrap;">Speed:</label>
						<input type="range" id="speech-rate" min="100" max="300" value="200" style="flex: 1;">
						<span id="speech-rate-label" style="min-width: 60px; text-align: center;">200 WPM</span>
						<button id="test-tts-button" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">üéµ Test</button>
					</div>
				</div>

				<!-- Target Device Type Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üîß</span>
						Target Device Type Settings
					</h3>
					
					<div class="form-group">
						<label for="target-type">Target Type</label>
						<select id="target-type" aria-describedby="target-type-help">
							<option value="computer">Computer (LAN/Internet)</option>
							<option value="modem">Modem (SDR/Radio)</option>
						</select>
						<div id="target-type-help" class="help-text">
							Affects keepalive and timeout behavior
						</div>
					</div>
					
					<div class="form-group">
						<label for="keepalive-interval">Keepalive Interval (seconds)</label>
						<input type="number" 
							   id="keepalive-interval" 
							   placeholder="2.0" 
							   min="0.5" 
							   max="60"
							   step="0.1"
							   aria-describedby="keepalive-help">
						<div id="keepalive-help" class="help-text">
							Keepalive timing for computer targets
						</div>
					</div>
				</div>

				<!-- GPIO Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üîå</span>
						GPIO Settings (Raspberry Pi)
					</h3>
					
					<div class="form-group">
						<label for="ptt-pin">PTT GPIO Pin</label>
						<input type="number" 
							   id="ptt-pin" 
							   placeholder="23" 
							   min="2" 
							   max="27"
							   aria-describedby="ptt-pin-help">
						<div id="ptt-pin-help" class="help-text">
							GPIO pin for PTT button
						</div>
					</div>
					
					<div class="form-group">
						<label for="led-pin">LED GPIO Pin</label>
						<input type="number" 
							   id="led-pin" 
							   placeholder="17" 
							   min="2" 
							   max="27"
							   aria-describedby="led-pin-help">
						<div id="led-pin-help" class="help-text">
							GPIO pin for PTT LED indicator
						</div>
					</div>
				</div>

				<!-- Debug Configuration -->
				<div class="config-section">
					<h3 class="section-header">
						<span aria-hidden="true">üõ†</span>
						Debug Settings
					</h3>
					
					<div class="checkbox-group">
						<input type="checkbox" id="verbose-mode">
						<label for="verbose-mode">Verbose Debug Output</label>
					</div>
					
					<div class="checkbox-group">
						<input type="checkbox" id="quiet-mode">
						<label for="quiet-mode">Quiet Mode (Minimal Output)</label>
					</div>
					
					<div class="form-group">
						<label for="log-level-config">Log Level</label>
						<select id="log-level-config">
							<option value="DEBUG">Debug (All Messages)</option>
							<option value="INFO" selected>Info (Normal)</option>
							<option value="WARNING">Warning (Important Only)</option>
							<option value="ERROR">Error (Problems Only)</option>
						</select>
					</div>
				</div>
			</div>
		</div>

		<!-- Status Panel (Always Visible) -->
		<div class="panel">
			<h2 class="panel-title">
				<span class="panel-icon">üìä</span>
				System Status
			</h2>
			
			<div class="status-grid">
				<div class="stat-item">
					<span class="stat-label">Connection</span>
					<span id="connection-stat" class="stat-value">CONNECTING</span>
				</div>
				
				<div class="stat-item">
					<span class="stat-label">Text Messages Sent</span>
					<span id="messages-sent" class="stat-value">0</span>
				</div>
				
				<div class="stat-item">
					<span class="stat-label">Text Messages Received</span>
					<span id="messages-received" class="stat-value">0</span>
				</div>
				
				<div class="stat-item">
					<span class="stat-label">Uptime</span>
					<span id="uptime" class="stat-value">00:00</span>
				</div>
			</div>
			
			<!-- System Log -->
			<div class="log-section">
				<h3>System Log</h3>
				<div class="log-controls">
					<label for="log-level">Filter log messages by severity level</label>
					<select id="log-level">
						<option value="all">All Messages</option>
						<option value="info">Info and Above</option>
						<option value="warning">Warnings and Errors</option>
						<option value="error">Errors Only</option>
					</select>
					
					<button class="btn" onclick="clearLog()" aria-describedby="clear-log-help">
						Clear Log
					</button>
					<div id="clear-log-help" class="sr-only">Removes all messages from the system log display</div>
				</div>
				
				<div id="system-log" 
					 class="system-log" 
					 role="log" 
					 aria-live="polite"
					 aria-label="System log messages"
					 tabindex="0">
				</div>
			</div>
		</div>
	</main>

	<!-- Notification system -->
	<div id="notification" class="notification"></div>

	<!-- JavaScript Files -->
	<script src="/static/js/typography.js"></script>
	<script src="/static/js/websocket.js"></script>
	<script src="/static/js/app.js"></script>
	<script src="/static/js/audio.js"></script>
	<script src="/static/js/config.js"></script>
</body>
</html>